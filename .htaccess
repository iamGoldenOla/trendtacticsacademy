############################################
# BASIC SETTINGS
############################################

Options -MultiViews
RewriteEngine On


############################################
# CANONICAL REDIRECTS
############################################

# Redirect /home → /
RewriteRule ^home/?$ / [L,R=301]

# Redirect index.html → /
RewriteRule ^index\.html$ / [L,R=301]


############################################
# DYNAMIC COURSE ROUTES (MUST COME EARLY)
############################################

# Course detail page
RewriteRule ^course/([^/]+)/?$ /course.html?slug=$1 [L,QSA]

# Learning page
RewriteRule ^learn/([^/]+)/?$ /learn.html?course_id=$1 [L,QSA]


############################################
# REDIRECT OLD HARD-CODED ROUTES
############################################

RewriteRule ^course-detail/?$ /course/vibe-coding [R=301,L]
RewriteRule ^prompt-engineering/?$ /course/prompt-engineering [R=301,L]
RewriteRule ^facebook-ads/?$ /course/facebook-ads [R=301,L]


############################################
# DO NOT TOUCH API / SUPABASE CALLS
############################################

RewriteCond %{REQUEST_URI} ^/api/
RewriteRule ^ - [L]


############################################
# SERVE REAL FILES & FOLDERS
############################################

RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]


############################################
# HTML EXTENSION MAPPING
############################################

RewriteCond %{REQUEST_FILENAME}.html -f
RewriteRule ^(.+?)/?$ $1.html [L]


############################################
# SPA FALLBACK (LAST RULE – VERY IMPORTANT)
############################################

RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/course/
RewriteCond %{REQUEST_URI} !^/learn/
RewriteRule ^ /index.html [L]


############################################
# HEADERS & CACHING (FIXED CSP)
############################################

<IfModule mod_headers.c>

    # -------------------------
    # CONTENT SECURITY POLICY
    # -------------------------
    Header always set Content-Security-Policy "default-src 'self' https:; \
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://js.puter.com https://www.googletagmanager.com https://www.google-analytics.com https://*.googletagmanager.com https://*.google-analytics.com https://*.googleapis.com https://www.youtube.com https://s.ytimg.com https://*.youtube.com https://youtube-nocookie.com https://*.youtube-nocookie.com https://*.supabase.co; \
    connect-src 'self' https://uimdbodamoeyukrghchb.supabase.co https://*.supabase.co https://supabase.co https://app.supabase.com wss://*.supabase.co; \
    img-src 'self' data: https:; \
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com https://*.googleapis.com; \
    font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; \
    frame-src https://www.youtube.com https://*.youtube.com https://youtube-nocookie.com https://*.youtube-nocookie.com;"

    # -------------------------
    # NO CACHE FOR HTML
    # -------------------------
    <FilesMatch "\.html$">
        Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>

    # -------------------------
    # LONG CACHE FOR STATIC
    # -------------------------
    <FilesMatch "\.(js|css|jpg|jpeg|png|gif|svg|webp|ico|woff|woff2)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>

</IfModule>
