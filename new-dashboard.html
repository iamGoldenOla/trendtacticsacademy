<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Trendtactics Academy</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="icon" href="/images/Trendtactics-logo - Copy.jpg" type="image/jpeg">
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    <script src="/js/env.js"></script>
    <script src="/js/supabase-client.js"></script>
    
    <style>
        :root {
            --primary: #00D9FF;
            --primary-dark: #00B8D9;
            --secondary: #7C3AED;
            --bg-dark: #0B1437;
            --bg-darker: #060D24;
            --bg-card: rgba(15, 25, 55, 0.95);
            --text-primary: #FFFFFF;
            --text-secondary: #94A3B8;
            --text-muted: #64748B;
            --success: #10B981;
            --error: #EF4444;
            --border: rgba(0, 217, 255, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-darker);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 2rem;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .welcome-section {
            margin-bottom: 2rem;
        }

        .welcome-section h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .welcome-section p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 217, 255, 0.1);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .courses-section h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .courses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .course-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }

        .course-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 35px rgba(0, 217, 255, 0.15);
        }

        .course-image {
            height: 160px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
        }

        .course-content {
            padding: 1.5rem;
        }

        .course-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .course-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .course-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .progress-container {
            margin-bottom: 1rem;
        }

        .progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.25rem;
        }

        .progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: right;
        }

        .course-actions {
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
        }

        .btn-primary {
            background: var(--primary);
            color: #000;
            flex: 1;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .recent-activity {
            margin-top: 2rem;
        }

        .recent-activity h3 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }

        .activity-list {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .activity-item {
            display: flex;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            background: rgba(0, 217, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            color: var(--primary);
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .activity-time {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .course-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <div class="welcome-section">
                <h1>Welcome back, <span id="userName">Student</span> üëã</h1>
                <p>Continue your learning journey and explore new courses</p>
            </div>
            <div class="user-info">
                <div class="avatar" style="width: 40px; height: 40px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: black; font-weight: bold;">
                    S
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalCourses">0</div>
                <div class="stat-label">Total Courses</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completedCourses">0</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="inProgress">0</div>
                <div class="stat-label">In Progress</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="hoursLearned">0</div>
                <div class="stat-label">Hours Learned</div>
            </div>
        </div>

        <div class="courses-section">
            <h2>üìö My Courses</h2>
            <div class="courses-grid" id="coursesGrid">
                <!-- Courses will be loaded here -->
                <div class="course-card">
                    <div class="course-image">‚è≥</div>
                    <div class="course-content">
                        <div class="course-title">Loading courses...</div>
                        <div class="course-description">Please wait while we load your courses</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="recent-activity">
            <h3>Recent Activity</h3>
            <div class="activity-list" id="activityList">
                <div class="activity-item">
                    <div class="activity-icon">‚è±Ô∏è</div>
                    <div class="activity-content">
                        <div class="activity-title">Loading recent activity...</div>
                        <div class="activity-time">Just now</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let user = null;
        let courses = [];

        // Initialize dashboard
        async function init() {
            try {
                // Check authentication using Auth utility
                const isLoggedIn = await Auth.isLoggedIn();
                if (!isLoggedIn) {
                    window.location.href = '/login';
                    return;
                }

                // Get user info using Auth utility
                user = await Auth.getCurrentUser();
                if (user) {
                    document.getElementById('userName').textContent = user.email?.split('@')[0] || 'Student';
                }

                // Load dashboard data
                await loadDashboardData();
                
                // Load courses
                await loadCourses();
                
                // Load recent activity
                await loadRecentActivity();
                
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                showError('Failed to load dashboard. Please refresh the page.');
            }
        }

        async function loadDashboardData() {
            try {
                // Mock data for now - would come from Supabase in real implementation
                document.getElementById('totalCourses').textContent = '1';
                document.getElementById('completedCourses').textContent = '0';
                document.getElementById('inProgress').textContent = '1';
                document.getElementById('hoursLearned').textContent = '5';
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        async function loadCourses() {
            try {
                // For now, let's create a mock course with 26 lessons to test
                const mockCourses = [
                    {
                        id: 'e9e58e4a-2f3b-4c9a-8a3d-1e5f6a7b8c9d',
                        title: 'Vibe Coding: Building Real Software with AI',
                        description: 'Learn to create digital products by focusing on ideas, intention, creativity, and guidance ‚Äî often with the help of AI ‚Äî instead of memorizing code syntax or complex technical rules.',
                        thumbnail_url: '/images/vibe-coding-thumb.jpg',
                        level: 'Beginner',
                        progress: 15, // Showing 15% as an example
                        lessons_completed: 4,
                        total_lessons: 26, // This is the important part - 26 lessons
                        instructor: 'AI Instructor',
                        duration: '6 weeks',
                        last_accessed: '2024-01-08'
                    }
                ];

                courses = mockCourses;
                renderCourses(courses);
            } catch (error) {
                console.error('Error loading courses:', error);
                showError('Failed to load courses. Please try again.');
            }
        }

        function renderCourses(courses) {
            const grid = document.getElementById('coursesGrid');
            grid.innerHTML = '';

            courses.forEach(course => {
                const card = document.createElement('div');
                card.className = 'course-card';
                
                card.innerHTML = `
                    <div class="course-image">üöÄ</div>
                    <div class="course-content">
                        <h3 class="course-title">${course.title}</h3>
                        <p class="course-description">${course.description}</p>
                        
                        <div class="course-meta">
                            <span class="course-level">${course.level}</span>
                            <span class="course-duration">${course.duration}</span>
                        </div>
                        
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${course.progress}%"></div>
                            </div>
                            <div class="progress-text">${course.lessons_completed}/${course.total_lessons} lessons completed</div>
                        </div>
                        
                        <div class="course-actions">
                            <a href="/learn?id=${course.id}" class="btn btn-primary" onclick="navigateToCourse('${course.id}')">Continue Learning</a>
                            <a href="/course/${course.id}" class="btn btn-outline">View Details</a>
                        </div>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        function navigateToCourse(courseId) {
            // Prevent default behavior and properly navigate
            event.preventDefault();
            window.location.href = `/learn?id=${courseId}`;
        }

        async function loadRecentActivity() {
            try {
                // Mock recent activity data
                const activities = [
                    {
                        id: 1,
                        title: 'Started "What is Vibe Coding?" lesson',
                        time: '2 minutes ago',
                        icon: 'üìñ'
                    },
                    {
                        id: 2,
                        title: 'Completed quiz in Module 1',
                        time: '1 hour ago',
                        icon: '‚úÖ'
                    },
                    {
                        id: 3,
                        title: 'Joined Vibe Coding course',
                        time: 'Yesterday',
                        icon: 'üéì'
                    }
                ];

                renderActivities(activities);
            } catch (error) {
                console.error('Error loading recent activity:', error);
            }
        }

        function renderActivities(activities) {
            const list = document.getElementById('activityList');
            list.innerHTML = '';

            activities.forEach(activity => {
                const item = document.createElement('div');
                item.className = 'activity-item';
                item.innerHTML = `
                    <div class="activity-icon">${activity.icon}</div>
                    <div class="activity-content">
                        <div class="activity-title">${activity.title}</div>
                        <div class="activity-time">${activity.time}</div>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function showError(message) {
            const grid = document.getElementById('coursesGrid');
            grid.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--error);">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                    <div>${message}</div>
                    <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--primary); color: black; border: none; border-radius: 4px; cursor: pointer;">Retry</button>
                </div>
            `;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);

        // Add this function to handle the view course button properly
        function handleViewCourse(courseId) {
            event.preventDefault();
            // Navigate to the specific course page
            window.location.href = `/course/${courseId}`;
        }
    </script>
</body>
</html>