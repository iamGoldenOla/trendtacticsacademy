<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Loading Course - Trendtactics Academy</title>
    <link rel="stylesheet" href="/css/main.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    <script src="/js/env.js"></script>
    <script src="/js/supabase-client.js"></script>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="container header-content">
            <div class="logo">Trendtactics Academy</div>
            <nav class="nav">
                <a href="/">Home</a>
                <a href="/about">About</a>
                <a href="/services">Services</a>
                <a href="/courses">Courses</a>
                <a href="/blog">Blog</a>
                <a href="https://trendtacticsdigital.com" target="_blank">Digital Services</a>
                <a href="/contact">Contact</a>
                <button class="btn btn-secondary" id="authBtn" onclick="handleAuthClick()">Sign In</button>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container" style="padding: 3rem 0;">
        <div id="loadingMessage" style="text-align: center; padding: 3rem 0;">
            <div class="spinner" style="width: 40px; height: 40px; border: 4px solid rgba(0,217,255,0.2); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
            <p>Loading course information...</p>
        </div>
        
        <div id="courseContent" style="display: none;">
            <!-- Course Hero -->
            <div class="hero">
                <span class="badge badge-primary" id="courseLevel">Beginner Friendly</span>
                <h1 class="hero-title" id="courseTitle">Course Title</h1>
                <p class="hero-subtitle" id="courseDescription">Course description will appear here</p>
            </div>

            <!-- Course Info Grid -->
            <div class="grid grid-2" style="margin-bottom: 3rem;">
                <!-- Course Details Card -->
                <div class="card">
                    <h2 class="card-title">Course Overview</h2>
                    <p class="card-description" id="courseOverview">
                        Course overview will appear here.
                    </p>

                    <div style="margin-top: 2rem;">
                        <h3 style="margin-bottom: 1rem; font-size: 1.25rem;">What You'll Learn</h3>
                        <ul style="list-style: none; padding: 0;" id="learningObjectives">
                            <!-- Learning objectives will be populated here -->
                        </ul>
                    </div>
                </div>

                <!-- Enrollment Card -->
                <div class="card"
                    style="background: linear-gradient(135deg, var(--primary), var(--secondary)); border: none;">
                    <h2 class="card-title" style="color: white;">Ready to Start?</h2>
                    <p style="color: rgba(255,255,255,0.9); margin-bottom: 2rem;">
                        Join thousands of learners and begin your creative coding journey today.
                    </p>

                    <div
                        style="background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: var(--radius); margin-bottom: 2rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                            <span style="color: rgba(255,255,255,0.9);">Duration</span>
                            <span style="color: white; font-weight: 600;" id="courseDuration">6 weeks</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                            <span style="color: rgba(255,255,255,0.9);">Level</span>
                            <span style="color: white; font-weight: 600;" id="courseLevelDisplay">Beginner</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: rgba(255,255,255,0.9);">Price</span>
                            <span style="color: white; font-weight: 600; font-size: 1.5rem;" id="coursePrice">FREE</span>
                        </div>
                    </div>

                    <button class="btn btn-lg" id="enrollBtn" onclick="handleEnroll()"
                        style="width: 100%; background: white; color: var(--primary);">
                        <span id="enrollBtnText">Enroll Now</span>
                    </button>

                    <div id="enrollMessage"
                        style="margin-top: 1rem; padding: 1rem; border-radius: var(--radius); display: none;"></div>
                </div>
            </div>

            <!-- Course Modules -->
            <div class="card">
                <h2 class="card-title">Course Structure</h2>
                <div style="margin-top: 2rem;" id="courseModules">
                    <!-- Modules will be populated here -->
                </div>
            </div>
        </div>

        <!-- Scripts -->
        <script src="/js/auth.js"></script>
        <script>
            // Get course slug from URL
            const urlParts = window.location.pathname.split('/');
            const courseSlug = urlParts[urlParts.length - 1];
            
            // Fetch course information based on slug
            async function loadCourseBySlug(slug) {
                try {
                    // Try to find course by slug first
                    const { data: courseBySlug, error: slugError } = await window.supabaseClient
                        .from('courses')
                        .select('*')
                        .eq('slug', slug)
                        .single();

                    if (courseBySlug) {
                        displayCourse(courseBySlug);
                        return;
                    }

                    // If not found by slug, try by title (for backward compatibility)
                    const { data: courseByTitle, error: titleError } = await window.supabaseClient
                        .from('courses')
                        .select('*')
                        .ilike('title', `%${slug}%`) // Case insensitive partial match
                        .single();

                    if (courseByTitle) {
                        displayCourse(courseByTitle);
                        return;
                    }

                    // If still not found, default to Vibe Coding as fallback
                    console.warn('Course not found, loading default course');
                    const { data: defaultCourse, error: defaultError } = await window.supabaseClient
                        .from('courses')
                        .select('*')
                        .ilike('title', '%Vibe Coding%')
                        .single();

                    if (defaultCourse) {
                        displayCourse(defaultCourse);
                    } else {
                        console.error('Default course not found either');
                        document.getElementById('loadingMessage').innerHTML = '<p>Course not found</p>';
                    }
                } catch (error) {
                    console.error('Error loading course:', error);
                    document.getElementById('loadingMessage').innerHTML = '<p>Error loading course</p>';
                }
            }

            function displayCourse(course) {
                // Update page title
                document.getElementById('pageTitle').textContent = `${course.title} - Trendtactics Academy`;
                
                // Update course information
                document.getElementById('courseTitle').textContent = course.title;
                document.getElementById('courseDescription').textContent = course.description || 'Course description not available.';
                document.getElementById('courseOverview').textContent = course.description || 'Course overview not available.';
                document.getElementById('courseLevel').textContent = course.level || 'All Levels';
                document.getElementById('courseLevelDisplay').textContent = course.level || 'All Levels';
                document.getElementById('courseDuration').textContent = course.duration || '6 weeks';
                document.getElementById('coursePrice').textContent = course.price || 'FREE';
                
                // Update learning objectives if available
                if (course.objectives && Array.isArray(course.objectives) && course.objectives.length > 0) {
                    const objectivesList = document.getElementById('learningObjectives');
                    objectivesList.innerHTML = course.objectives.map(obj => `<li style="padding: 0.5rem 0; color: var(--text-secondary);">${obj}</li>`).join('');
                } else if (course.what_you_will_learn && Array.isArray(course.what_you_will_learn)) {
                    const objectivesList = document.getElementById('learningObjectives');
                    objectivesList.innerHTML = course.what_you_will_learn.map(obj => `<li style="padding: 0.5rem 0; color: var(--text-secondary);">${obj}</li>`).join('');
                }
                
                // Update modules if available
                if (course.modules) {
                    let modulesData = course.modules;
                    
                    // Handle if modules is a string that needs to be parsed
                    if (typeof modulesData === 'string') {
                        try {
                            modulesData = JSON.parse(modulesData);
                        } catch (e) {
                            console.error('Error parsing modules:', e);
                        }
                    }
                    
                    // Handle if modules has a nested structure like {modules: [...]}
                    if (modulesData && modulesData.modules && Array.isArray(modulesData.modules)) {
                        modulesData = modulesData.modules;
                    }
                    
                    if (Array.isArray(modulesData)) {
                        const modulesContainer = document.getElementById('courseModules');
                        modulesContainer.innerHTML = modulesData.map(module => {
                            const lessonCount = module.lessons ? module.lessons.length : 0;
                            return `
                                <div style="padding: 1.5rem; background: var(--bg-tertiary); border-radius: var(--radius); margin-bottom: 1rem;">
                                    <h3 style="font-size: 1.125rem; margin-bottom: 0.5rem;">${module.title}</h3>
                                    <p style="color: var(--text-secondary); font-size: 0.875rem;">${lessonCount} lessons • ${module.duration || '1 week'}</p>
                                </div>
                            `;
                        }).join('');
                    }
                }
                
                // Hide loading and show content
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('courseContent').style.display = 'block';
                
                // Set the course ID for enrollment
                window.COURSE_ID = course.id;
                
                // Reinitialize the page functionality
                initPage();
            }

            // Check auth status on load
            async function initPage() {
                const loggedIn = await Auth.isLoggedIn();
                const authBtn = document.getElementById('authBtn');
                const dashboardLink = document.getElementById('dashboardLink');

                if (loggedIn) {
                    const user = await Auth.getCurrentUser();
                    authBtn.textContent = user?.name || 'Account';
                    authBtn.onclick = () => window.location.href = '/dashboard';
                    if(dashboardLink) dashboardLink.style.display = 'block';

                    // Check if already enrolled
                    await checkEnrollment();
                }
            }

            // Check if user is already enrolled
            async function checkEnrollment() {
                if (!window.COURSE_ID) return;
                
                try {
                    const user = await Auth.getCurrentUser();
                    if (!user) return;

                    const { data, error } = await window.supabaseClient
                        .from('enrollments')
                        .select('*')
                        .eq('user_id', user.id)
                        .eq('course_id', window.COURSE_ID)
                        .single();

                    if (data) {
                        const enrollBtn = document.getElementById('enrollBtn');
                        const enrollBtnText = document.getElementById('enrollBtnText');
                        enrollBtnText.textContent = 'Continue Learning';
                        enrollBtn.onclick = () => window.location.href = '/dashboard';
                    }
                } catch (error) {
                    console.log('Not enrolled yet');
                }
            }

            // Handle auth button click
            function handleAuthClick() {
                window.location.href = '/signup';
            }

            // Handle enrollment
            async function handleEnroll() {
                if (!window.COURSE_ID) {
                    console.error('Course ID not set');
                    return;
                }
                
                const enrollBtn = document.getElementById('enrollBtn');
                const enrollBtnText = document.getElementById('enrollBtnText');
                const enrollMessage = document.getElementById('enrollMessage');

                // Check if logged in
                const loggedIn = await Auth.isLoggedIn();
                if (!loggedIn) {
                    window.location.href = '/signup?redirect=' + encodeURIComponent(window.location.pathname);
                    return;
                }

                // Disable button
                enrollBtn.disabled = true;
                enrollBtnText.innerHTML = '<span class="spinner"></span> Enrolling...';

                try {
                    const user = await Auth.getCurrentUser();

                    // Create enrollment
                    const { data, error } = await window.supabaseClient
                        .from('enrollments')
                        .insert({
                            user_id: user.id,
                            course_id: window.COURSE_ID,
                            enrolled_at: new Date().toISOString()
                        })
                        .select()
                        .single();

                    if (error) {
                        // Check if already enrolled
                        if (error.code === '23505') {
                            enrollMessage.style.display = 'block';
                            enrollMessage.style.background = 'rgba(16, 185, 129, 0.1)';
                            enrollMessage.style.color = 'var(--success)';
                            enrollMessage.textContent = '✅ You are already enrolled!';

                            setTimeout(() => {
                                window.location.href = '/dashboard';
                            }, 1500);
                        } else {
                            throw error;
                        }
                    } else {
                        enrollMessage.style.display = 'block';
                        enrollMessage.style.background = 'rgba(16, 185, 129, 0.1)';
                        enrollMessage.style.color = 'var(--success)';
                        enrollMessage.textContent = '✅ Enrollment successful! Redirecting...';

                        setTimeout(() => {
                            window.location.href = '/dashboard';
                        }, 1500);
                    }
                } catch (error) {
                    console.error('Enrollment error:', error);
                    enrollMessage.style.display = 'block';
                    enrollMessage.style.background = 'rgba(239, 68, 68, 0.1)';
                    enrollMessage.style.color = 'var(--error)';
                    enrollMessage.textContent = '❌ ' + error.message;

                    enrollBtn.disabled = false;
                    enrollBtnText.textContent = 'Try Again';
                }
            }

            // Initialize when page loads
            window.addEventListener('load', () => {
                if (courseSlug) {
                    loadCourseBySlug(courseSlug);
                } else {
                    // If no slug in URL, show an error or default behavior
                    document.getElementById('loadingMessage').innerHTML = '<p>Invalid course URL</p>';
                }
            });
        </script>
    </body>
</html>