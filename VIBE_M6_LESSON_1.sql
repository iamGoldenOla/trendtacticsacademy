-- ==========================================
-- VIBE CODING MODULE 6 - ALL 3 LESSONS
-- Data, State & Auth
-- Compact HTML formatting
-- ==========================================

DO $$
DECLARE
    v_course_id UUID;
    v_module_id UUID;
BEGIN
    SELECT id INTO v_course_id FROM courses WHERE title ILIKE '%Vibe Coding%' LIMIT 1;
    IF v_course_id IS NULL THEN RAISE EXCEPTION 'Vibe Coding course not found'; END IF;
    
    SELECT id INTO v_module_id FROM modules WHERE course_id = v_course_id AND ordering = 6 LIMIT 1;
    IF v_module_id IS NULL THEN RAISE EXCEPTION 'Module 6 not found'; END IF;
    
    RAISE NOTICE 'ðŸ“š Expanding Vibe Coding Module 6 (All 3 Lessons)...';
    
    -- LESSON 19: Databases Without Fear
    UPDATE lessons SET content = '<div class="lesson-content"><h2>Databases Without Fear</h2><h3>Demystifying Data Storage</h3><p>Databases used to be intimidatingâ€”complex SQL syntax, normalization rules, performance tuning. With AI assistance, you can design, build, and manage databases without needing to be a database expert. This lesson teaches you how to work with databases confidently using Vibe Coding.</p><h3>Understanding Databases at a High Level</h3><p>A database is simply organized storage for your application''s data. Think of it as: Spreadsheets on steroids (tables with rows and columns). Relationships between data (users have posts, posts have comments). Rules for data integrity (email must be unique, age must be positive). Fast searching and filtering (find all users in California).</p><h3>Relational vs NoSQL Databases</h3><h4>Relational Databases (SQL)</h4><p><strong>Examples:</strong> PostgreSQL, MySQL, SQLite<br><strong>Best for:</strong> Structured data with clear relationships, complex queries, data integrity requirements<br><strong>Think:</strong> Spreadsheets with links between them</p><p>Prompt: "I need a database for an e-commerce store with users, products, orders, and reviews. Should I use SQL or NoSQL?"<br>AI will likely recommend: SQL (PostgreSQL) because of clear relationships and need for transactions.</p><h4>NoSQL Databases</h4><p><strong>Examples:</strong> MongoDB, Firebase Firestore, DynamoDB<br><strong>Best for:</strong> Flexible schemas, real-time data, rapid prototyping, hierarchical data<br><strong>Think:</strong> JSON documents in folders</p><p>Prompt: "I''m building a chat app with real-time messages. Should I use SQL or NoSQL?"<br>AI will likely recommend: NoSQL (Firestore) for real-time capabilities and flexible message structure.</p><h3>Designing Your Database Schema with AI</h3><h4>Start with Your Data Model</h4><p>Describe your entities and relationships: "I''m building a blog platform. I have: Users (who write posts). Posts (written by users, can have many comments). Comments (on posts, written by users). Categories (posts can belong to multiple categories). Tags (posts can have many tags)."</p><h4>AI Generates the Schema</h4><p>Prompt: "Create a PostgreSQL database schema for this blog platform. Include: All necessary tables. Proper data types. Primary and foreign keys. Indexes for performance. Timestamps (created_at, updated_at). Any junction tables needed for many-to-many relationships."</p><p>AI will create: users table, posts table, comments table, categories table, tags table, post_categories junction table, post_tags junction table.</p><h4>Refining the Schema</h4><p>Prompt: "Add to the schema: Soft deletes (deleted_at column). User roles (admin, editor, author, reader). Post status (draft, published, archived). Comment moderation (approved, pending, spam). Full-text search on post title and content."</p><h3>Common Database Patterns</h3><h4>One-to-Many Relationships</h4><p>Example: One user has many posts.<br>Prompt: "Create tables for users and posts where each post belongs to one user."<br>Result: posts table has user_id foreign key.</p><h4>Many-to-Many Relationships</h4><p>Example: Posts can have many tags, tags can be on many posts.<br>Prompt: "Create a many-to-many relationship between posts and tags."<br>Result: Junction table post_tags with post_id and tag_id.</p><h4>Self-Referencing Relationships</h4><p>Example: Comments can have replies (comments on comments).<br>Prompt: "Allow comments to have nested replies."<br>Result: comments table has parent_id column referencing itself.</p><h3>Working with Databases Using AI</h3><h4>Creating Tables</h4><p>Prompt: "Write SQL to create a users table with: id (UUID, primary key). email (unique, required). name (required). avatar_url (optional). role (enum: admin, user). created_at, updated_at (timestamps)."</p><h4>Querying Data</h4><p>Instead of memorizing SQL syntax, describe what you want: "Get all published posts from the last 30 days, ordered by view count, with author information."<br>AI generates: SELECT posts.*, users.name as author_name FROM posts JOIN users ON posts.user_id = users.id WHERE posts.status = ''published'' AND posts.created_at >= NOW() - INTERVAL ''30 days'' ORDER BY posts.view_count DESC;</p><h4>Updating Data</h4><p>Prompt: "Update all posts by user ID 123 to set status as ''archived'' if they haven''t been updated in over a year."</p><h4>Complex Queries</h4><p>Prompt: "Find the top 10 users by total post views, including their post count and average views per post."</p><h3>Database Best Practices with AI</h3><h4>Indexing for Performance</h4><p>Prompt: "Which columns should I index in my database? I frequently: Search posts by user_id. Filter posts by status and created_at. Search users by email. Look up comments by post_id."<br>AI recommends: Index on posts(user_id), posts(status, created_at), users(email), comments(post_id).</p><h4>Data Validation</h4><p>Prompt: "Add database constraints to ensure: Email is valid format and unique. Age is between 13 and 120. Price is positive. Username is 3-20 characters, alphanumeric only."</p><h4>Migrations</h4><p>Prompt: "Create a migration to: Add a ''bio'' column to users table. Rename ''title'' to ''headline'' in posts. Add an index on posts(published_at). Make these changes safely without losing data."</p><h3>Using Supabase with AI</h3><h4>Setting Up Supabase</h4><p>Prompt: "Help me set up Supabase for my project: Create tables for [your entities]. Set up authentication. Configure row-level security. Create API endpoints. Set up real-time subscriptions."</p><h4>Row-Level Security (RLS)</h4><p>Prompt: "Create RLS policies for my blog: Users can read all published posts. Users can create posts (assigned to themselves). Users can update/delete only their own posts. Admins can do everything. Anonymous users can only read published posts."</p><h4>Real-Time Subscriptions</h4><p>Prompt: "Set up real-time subscriptions so: Users see new comments appear instantly. Post view counts update live. User online status shows in real-time."</p><h3>Common Database Challenges</h3><h4>Challenge 1: N+1 Query Problem</h4><p>Problem: Loading a list of posts, then making a separate query for each post''s author.<br>Prompt: "I''m getting slow performance loading posts with authors. How do I fix the N+1 problem?"<br>Solution: AI suggests using JOIN or eager loading.</p><h4>Challenge 2: Slow Queries</h4><p>Problem: Queries taking too long.<br>Prompt: "This query is slow: [paste query]. How can I optimize it?"<br>AI analyzes and suggests: Add indexes, rewrite query, use materialized views, or add caching.</p><h4>Challenge 3: Data Integrity</h4><p>Problem: Orphaned records, inconsistent data.<br>Prompt: "How do I ensure data integrity when: Deleting a user (what happens to their posts?). Deleting a post (what happens to comments?). Updating related records?"<br>AI suggests: Foreign key constraints with CASCADE options, soft deletes, or transaction handling.</p><h3>Database Migrations with AI</h3><p>Prompt: "Create a migration to safely: Add a new column. Rename an existing column. Change a column type. Add a new table. Modify relationships. Ensure no data loss and minimal downtime."</p><h3>Backup and Recovery</h3><p>Prompt: "Set up database backups: Daily automated backups. Point-in-time recovery. Test restore procedures. Store backups securely. Alert on backup failures."</p><h3>Scaling Your Database</h3><p>As your app grows: Prompt: "My database is getting slow with 100k users. How should I scale? Options: Read replicas, connection pooling, caching layer, database sharding, query optimization."</p><h3>NoSQL with AI (Firebase/Firestore)</h3><h4>Document Structure</h4><p>Prompt: "Design a Firestore structure for a chat app with: Users, Conversations, Messages. Consider: Query patterns (recent conversations, messages in a conversation). Real-time updates. Security rules. Scalability."</p><h4>Security Rules</h4><p>Prompt: "Create Firestore security rules: Users can read/write their own data. Users can read conversations they''re part of. Users can write messages to conversations they''re in. Admins can read everything."</p><h3>Database Tools and AI</h3><p><strong>Supabase:</strong> AI helps with schema design, RLS policies, queries<br><strong>Prisma:</strong> AI generates schema, migrations, queries<br><strong>Drizzle:</strong> AI creates type-safe queries<br><strong>Firebase:</strong> AI designs document structure, security rules</p><h3>Testing Database Operations</h3><p>Prompt: "Create tests for database operations: Test user creation with valid/invalid data. Test querying with various filters. Test updating and deleting. Test relationship integrity. Test concurrent operations."</p><h3>Key Takeaways</h3><ul><li>Databases are just <strong>organized data storage</strong>â€”not as scary as they seem</li><li>Use AI to <strong>design schemas</strong> by describing your data model</li><li>AI can <strong>write queries</strong> from plain language descriptions</li><li>Implement <strong>best practices</strong>: indexing, validation, RLS</li><li>Solve common challenges: <strong>N+1 queries, slow performance, data integrity</strong></li><li>Choose the right database: <strong>SQL for structured data, NoSQL for flexibility</strong></li><li>Use modern tools like <strong>Supabase</strong> that work well with AI</li></ul><p>In the next lesson, we''ll tackle authentication and authorizationâ€”keeping your app secure.</p></div>'
    WHERE module_id = v_module_id AND ordering = 1;
    RAISE NOTICE 'âœ… Lesson 19 Complete';
    
    RAISE NOTICE 'ðŸŽ‰ Module 6 Lesson 1/3 Complete!';
    
END $$;
