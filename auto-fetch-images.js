// ==========================================
// AUTOMATIC IMAGE FETCHER FOR LESSONS
// Uses Unsplash API to find and add images
// ==========================================

const https = require('https');
const fs = require('fs');

// Unsplash API Configuration
// Get your free API key at: https://unsplash.com/developers
const UNSPLASH_ACCESS_KEY = 'YOUR_UNSPLASH_ACCESS_KEY_HERE'; // Free, unlimited for dev

// Load lesson image guide
const imageGuide = require('./LESSON_IMAGE_GUIDE.json');

// Function to search Unsplash for images
function searchUnsplash(query) {
    return new Promise((resolve, reject) => {
        const url = `https://api.unsplash.com/search/photos?query=${encodeURIComponent(query)}&per_page=1&orientation=landscape&client_id=${UNSPLASH_ACCESS_KEY}`;

        https.get(url, (res) => {
            let data = '';
            res.on('data', chunk => data += chunk);
            res.on('end', () => {
                try {
                    const result = JSON.parse(data);
                    if (result.results && result.results.length > 0) {
                        const image = result.results[0];
                        resolve({
                            url: image.urls.regular,
                            alt: image.alt_description || query,
                            photographer: image.user.name,
                            downloadUrl: image.links.download_location
                        });
                    } else {
                        resolve(null);
                    }
                } catch (e) {
                    reject(e);
                }
            });
        }).on('error', reject);
    });
}

// Generate SQL for all lessons
async function generateImageSQL() {
    const sqlStatements = [];
    const courses = imageGuide.image_guide.courses;

    console.log('üé® Fetching images from Unsplash...\n');

    for (const [courseKey, courseData] of Object.entries(courses)) {
        console.log(`\nüìö Processing: ${courseData.course_title}`);

        for (const lesson of courseData.lessons) {
            console.log(`  üîç Searching for: ${lesson.title}`);

            try {
                // Search for image
                const image = await searchUnsplash(lesson.suggested_search);

                if (image) {
                    // Generate SQL
                    const sql = `
-- ${lesson.title}
UPDATE lessons 
SET content = '<img src="${image.url}" 
               alt="${lesson.alt_text}" 
               style="width:100%; max-width:800px; border-radius:12px; margin:20px 0; box-shadow: 0 4px 6px rgba(0,217,255,0.1);"
               title="Photo by ${image.photographer} on Unsplash">' 
              || content
WHERE title = '${lesson.title.replace(/'/g, "''")}';
`;
                    sqlStatements.push(sql);
                    console.log(`    ‚úÖ Found image by ${image.photographer}`);
                } else {
                    console.log(`    ‚ö†Ô∏è  No image found`);
                }

                // Rate limiting - Unsplash allows 50 requests/hour for free
                await new Promise(resolve => setTimeout(resolve, 1000));

            } catch (error) {
                console.log(`    ‚ùå Error: ${error.message}`);
            }
        }
    }

    // Write SQL file
    const sqlContent = `-- ==========================================
-- AUTO-GENERATED IMAGE ADDITIONS
-- Generated by automatic image fetcher
-- Images from Unsplash (free for commercial use)
-- ==========================================

${sqlStatements.join('\n')}

-- Verification Query
SELECT 
    c.title as course,
    l.title as lesson,
    CASE 
        WHEN l.content LIKE '%<img src="https://images.unsplash.com%' THEN '‚úÖ Has Image'
        ELSE '‚ùå No Image'
    END as image_status
FROM lessons l
JOIN modules m ON l.module_id = m.id
JOIN courses c ON m.course_id = c.id
WHERE l.content LIKE '%<img src="https://images.unsplash.com%'
ORDER BY c.title, m.ordering, l.ordering;
`;

    fs.writeFileSync('AUTO_ADD_IMAGES.sql', sqlContent);
    console.log('\n‚úÖ Generated AUTO_ADD_IMAGES.sql');
    console.log(`üìä Total images found: ${sqlStatements.length}`);
}

// Run the script
if (UNSPLASH_ACCESS_KEY === 'YOUR_UNSPLASH_ACCESS_KEY_HERE') {
    console.log('‚ùå ERROR: Please set your Unsplash API key first!');
    console.log('\nüìù How to get a free API key:');
    console.log('1. Go to https://unsplash.com/developers');
    console.log('2. Register for a free account');
    console.log('3. Create a new application');
    console.log('4. Copy your Access Key');
    console.log('5. Paste it in this script (line 10)');
    console.log('\nüí° Free tier: 50 requests/hour (perfect for this!)');
} else {
    generateImageSQL().catch(console.error);
}
